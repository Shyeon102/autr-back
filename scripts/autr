#!/usr/bin/env bash
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  autr â€” Auto Trading CLI
#  Usage: autr [--status] [--trade start|stop]
#              [--strategy regime|dual|breakout|mean]
#              [--assets]
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
set -euo pipefail

# â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
AUTR_DIR="${AUTR_DIR:-$HOME/auto-trading-backend}"
ENV_FILE="$AUTR_DIR/.env"
API_BASE="${AUTR_API:-https://api.dataquantlab.com/api}"

# .env íŒŒì¼ì—ì„œ API í‚¤ ë¡œë“œ
if [[ -f "$ENV_FILE" ]]; then
  API_KEY=$(grep -E '^ADMIN_API_KEY=' "$ENV_FILE" | cut -d= -f2 | tr -d '"' | tr -d "'")
fi
API_KEY="${API_KEY:-${ADMIN_API_KEY:-}}"

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_json() {
  python3 -m json.tool 2>/dev/null || cat
}

_get() {
  curl -sf "$API_BASE$1" | _json
}

_post() {
  local path="$1"
  local body="${2:-}"
  if [[ -n "$body" ]]; then
    curl -sf -X POST "$API_BASE$path" \
      -H "X-API-KEY: $API_KEY" \
      -H "Content-Type: application/json" \
      -d "$body" | _json
  else
    curl -sf -X POST "$API_BASE$path" \
      -H "X-API-KEY: $API_KEY" | _json
  fi
}

_strategy_name() {
  case "$1" in
    regime)   echo "regime_trend" ;;
    dual)     echo "dual_timeframe" ;;
    breakout) echo "breakout_volume" ;;
    mean)     echo "mean_reversion" ;;
    *)
      echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì „ëµ: $1"
      echo "   ì‚¬ìš© ê°€ëŠ¥: regime | dual | breakout | mean"
      exit 1
      ;;
  esac
}

_usage() {
  cat <<EOF
Usage: autr [OPTIONS]

Options:
  -s, --strategy <name>   ì „ëµ ë³€ê²½ (regime|dual|breakout|mean)
  -t, --trade <action>    ìë™ë§¤ë§¤ ì‹œì‘/ì¤‘ì§€ (start|stop)
      --status            í˜„ì¬ ì „ëµ ìƒíƒœ ì¡°íšŒ
  -a, --assets            í˜„ì¬ ì”ê³  ì¡°íšŒ
  -h, --help              ë„ì›€ë§

Examples:
  autr --status
  autr --trade start
  autr --trade stop
  autr --strategy dual
  autr --assets
EOF
}

# â”€â”€ ì¸ì ì—†ìœ¼ë©´ status ë³´ì—¬ì£¼ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ $# -eq 0 ]]; then
  _get "/trading/status"
  exit 0
fi

# â”€â”€ ì¸ì íŒŒì‹± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
while [[ $# -gt 0 ]]; do
  case "$1" in
    -s|--strategy)
      STRATEGY=$(_strategy_name "${2:-}")
      echo "â¹ï¸  ìë™ë§¤ë§¤ ì¤‘ì§€"
      _post "/trading/stop" > /dev/null
      echo "ğŸ”„ ì „ëµ ë³€ê²½ â†’ $STRATEGY"
      _post "/trading/strategy" "{\"strategy\": \"$STRATEGY\"}"
      echo "â–¶ï¸  ìë™ë§¤ë§¤ ì‹œì‘"
      _post "/trading/start"
      shift 2
      ;;
    -t|--trade)
      ACTION="${2:-}"
      case "$ACTION" in
        start)
          echo "â–¶ï¸  ìë™ë§¤ë§¤ ì‹œì‘"
          _post "/trading/start"
          ;;
        stop)
          echo "â¹ï¸  ìë™ë§¤ë§¤ ì¤‘ì§€"
          _post "/trading/stop"
          ;;
        *)
          echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì•¡ì…˜: $ACTION"
          echo "   ì‚¬ìš© ê°€ëŠ¥: start | stop"
          exit 1
          ;;
      esac
      shift 2
      ;;
    --status)
      _get "/trading/status"
      shift
      ;;
    -a|--assets)
      _get "/portfolio"
      shift
      ;;
    -h|--help)
      _usage
      exit 0
      ;;
    *)
      echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜: $1"
      _usage
      exit 1
      ;;
  esac
done
